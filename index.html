<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JM's Gold Price Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 10px; background: #f8f9fa; color: #333; margin: 0; }
        .container { max-width: 100%; margin: auto; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .status-banner { text-align: center; padding: 12px; border-radius: 15px; font-weight: 800; font-size: 14px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .status-open { background: #e7f9ee; color: #2ecc71; border: 1px solid #2ecc71; }
        .status-closed { background: #fdf2f2; color: #e74c3c; border: 1px solid #e74c3c; }
        .status-target { background: #fff9e6; color: #d4af37; border: 2px solid #d4af37; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .header { text-align: center; margin-bottom: 20px; }
        .logo { width: 50px; height: 50px; margin-bottom: 8px; border-radius: 50%; background: #d4af37; display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; }
        
        .actions, .nav-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { padding: 14px; border-radius: 12px; text-decoration: none; text-align: center; font-weight: 700; font-size: 13px; border: none; cursor: pointer; }
        .btn-1g { background: #fff; color: #d4af37; border: 2px solid #d4af37; }
        .btn-5g { background: #d4af37; color: white; }
        .btn-secondary { background: #f1f3f4; color: #5f6368; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { padding: 15px; border-radius: 18px; background: #fff; border: 1px solid #f0f0f0; text-align: center; }
        .stat-value { font-size: 20px; font-weight: 800; color: #d4af37; }
        .stat-label { font-size: 10px; color: #999; text-transform: uppercase; }

        /* History Table Styles */
        .history-section { border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px; }
        .history-title { font-weight: 800; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 13px; }
        .history-date { color: #888; }
        .history-grams { font-weight: 600; }
        
        canvas { width: 100% !important; height: 280px !important; }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainBanner" class="status-banner">Loading...</div>

        <div class="header">
            <div class="logo">JM</div>
            <h1 style="margin: 0; font-size: 20px;">Gold Price Tracker</h1>
        </div>
        
        <div class="actions">
            <a href="https://www.perthmint.com/shop/bullion/minted-bars/kangaroo-1g-minted-gold-bar/" target="_blank" class="btn btn-1g">ðŸ›’ Buy 1g</a>
            <a href="https://www.perthmint.com/shop/bullion/minted-bars/kangaroo-5g-minted-gold-bar/" target="_blank" class="btn btn-5g">ðŸ›’ Buy 5g</a>
        </div>

        <div class="nav-actions">
            <button onclick="requestNotify()" class="btn btn-secondary">ðŸ”” Alerts On</button>
            <button onclick="location.reload()" class="btn btn-secondary">ðŸ”„ Refresh</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Grams</div>
                <div id="totalGrams" class="stat-value">-- g</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Live P/L</div>
                <div id="liveProfit" class="stat-value">--</div>
            </div>
        </div>

        <canvas id="goldChart"></canvas>

        <div class="history-section">
            <div class="history-title">ðŸ“œ Transaction History</div>
            <div id="historyList" class="history-list">
                </div>
        </div>
    </div>

    <script>
        const WA_HOLIDAYS = ["2026-01-01", "2026-01-26", "2026-03-02", "2026-04-03", "2026-04-06", "2026-04-25", "2026-06-01", "2026-09-28", "2026-12-25", "2026-12-26"];

        function requestNotify() {
            Notification.requestPermission().then(perm => { if(perm === 'granted') alert("Alerts active!"); });
        }

        function getStoreStatus() {
            const now = new Date();
            if (now.getDay() === 0 || WA_HOLIDAYS.includes(now.toISOString().split('T')[0])) return "CLOSED";
            return (now.getHours() >= 9 && now.getHours() < 17) ? "OPEN" : "AFTER HOURS";
        }

        Promise.all([
            new Promise(res => Papa.parse("gold_passbook.csv", {download: true, header: true, complete: res})),
            new Promise(res => Papa.parse("my_holdings.csv", {download: true, header: true, complete: res}))
        ]).then(([passbookRes, holdingsRes]) => {
            const history = passbookRes.data.filter(row => row.Date);
            const latest = history[history.length - 1];
            const currentPrice = parseFloat(latest.Spot_AUD_g);
            const targetPrice = parseFloat(latest.MA50_AUD) * 0.95;
            const status = getStoreStatus();
            const banner = document.getElementById('mainBanner');

            // Update Banner
            if (currentPrice <= targetPrice && status === "OPEN") {
                banner.innerText = "ðŸŽ¯ TARGET REACHED - BUY NOW";
                banner.className = "status-banner status-target";
            } else if (status === "OPEN") {
                banner.innerText = "STORE OPEN (Closes 5PM)";
                banner.className = "status-banner status-open";
            } else {
                banner.innerText = status === "CLOSED" ? "STORE CLOSED TODAY" : "STORE CLOSED (Opens 9AM)";
                banner.className = "status-banner status-closed";
            }

            // Load History and Calculate Stats
            let totalGrams = 0, totalCost = 0, historyHTML = "";
            holdingsRes.data.reverse().filter(row => row.Grams).forEach(row => {
                const g = parseFloat(row.Grams);
                const cost = parseFloat(row.Price_Paid_AUD);
                totalGrams += g;
                totalCost += (g * cost);
                historyHTML += `<div class="history-item"><span class="history-date">${row.Date}</span><span class="history-grams">${g}g @ $${cost}</span></div>`;
            });

            document.getElementById('historyList').innerHTML = historyHTML || "<div style='text-align:center;color:#ccc;'>No purchases logged yet.</div>";
            const profit = (totalGrams * currentPrice) - totalCost;
            document.getElementById('totalGrams').innerText = totalGrams.toFixed(1) + "g";
            document.getElementById('liveProfit').innerText = (profit >= 0 ? "+$" : "-$") + Math.abs(profit).toFixed(2);
            document.getElementById('liveProfit').style.color = profit >= 0 ? "#2ecc71" : "#e74c3c";

            new Chart(document.getElementById('goldChart'), {
                type: 'line',
                data: {
                    labels: history.map(row => row.Date.split(' ')[0]),
                    datasets: [{ label: 'Spot', data: history.map(row => row.Spot_AUD_g), borderColor: '#d4af37', fill: false, tension: 0.4, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        });
    </script>
</body>
</html>
